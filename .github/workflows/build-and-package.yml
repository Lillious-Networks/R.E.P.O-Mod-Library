name: Build and Package
on:
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - 'libs/**'
      - "**.csproj"
      - "**.sln"
      - "**.cs"

jobs:
  generate-build-number:
    name: Generate Build Number 🔢
    runs-on: windows-latest
    outputs:
      version: ${{ steps.generate-build-number.outputs.version }}
    steps:
      - name: Generate Build Number 🔢
        id: generate-build-number
        run: |
          $buildNumber = "1.0.${{ github.run_number }}"
          echo "version=$buildNumber" >> $env:GITHUB_OUTPUT

  # Install net472 and build the project
  build:
    name: "Build ${{ needs.generate-build-number.outputs.version }} Release 🏗"
    needs: generate-build-number
    concurrency:
      group: build
      cancel-in-progress: true
    runs-on: windows-2025
    steps:
      - name: Checkout code 🛒
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Restore dependencies 🛠️🔗
        run: dotnet restore Repo_Library.sln

      - name: NuGet Restore dependencies 🛠️🔗
        run: nuget restore Repo_Library.sln

      - name: Build
        working-directory: .
        run: dotnet build -c Release

      - name: Create NuGet nuspec file 📦
        shell: pwsh
        run: |
          $nuspecContent = @"
          <?xml version="1.0" encoding="utf-8"?>
          <package>
            <metadata>
              <id>RepoModLibrary</id>
              <version>${{ needs.generate-build-number.outputs.version }}</version>
              <title>(Official) R.E.P.O Mod Library</title>
              <authors>Lillious, .Zer0</authors>
              <requireLicenseAcceptance>false</requireLicenseAcceptance>
              <license type="expression">MIT</license>
              <description>The official mod library for the game R.E.P.O</description>
              <releaseNotes></releaseNotes>
              <copyright>Copyright © 2025</copyright>
              <tags></tags>
              <dependencies>
                <dependency id="LavaGang.MelonLoader" version="0.7.0" />
              </dependencies>
            </metadata>
            <files>
              <file src="bin\Release\Repo_Library.dll" target="lib"/>
              <file src="bin\Release\Assembly-CSharp.dll" target="lib"/>
              <file src="bin\Release\UnityEngine.CoreModule.dll" target="lib"/>
              <file src="bin\Release\UnityEngine.dll" target="lib"/>
            </files>
          </package>
          "@

          $nuspecContent | Out-File -Encoding utf8 -FilePath "Repo_Library.nuspec"

      - name: Pack NuGet package 📦
        run: nuget pack Repo_Library.nuspec -OutputDirectory .

      - name: Set up Git
        run: |
          git config --global user.email "logan.brown@tylertech.com"
          git config --global user.name "Logan Brown"

      - name: Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          tag_name: v${{ needs.generate-build-number.outputs.version }}
          name: Release v${{ needs.generate-build-number.outputs.version }}
          files: RepoModLibrary.${{ needs.generate-build-number.outputs.version }}.nupkg
          make_latest: true
          target_commitish: ${{ github.sha }}